<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Server Configuration</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Server Configuration</h1>
    <form id="serverForm">
        <label for="generation">Generation:</label>
        <select id="generation" name="generation">
            {% for gen in generation %}
                <option value="{{ gen[0] }}">{{ gen[0] }}</option>
            {% endfor %}
        </select>

        <label for="server">Server:</label>
        <select id="server" name="server"></select>

        <label for="cores">Cores:</label>
        <select id="cores" name="cores"></select>

        <label for="metric">Metric:</label>
        <select id="metric" name="metric">
            <option value="rperf">rperf</option>
            <option value="saps">saps</option>
            <option value="spec">spec</option>
            <option value="cpw">cpw</option>
        </select>

        <div id="metricData"></div>
        <button type="button" id="addServer">Add Server</button>
    </form>

    <table id="serverTable" border="1">
        <thead>
            <tr>
                <th>Generation</th>
                <th>Server</th>
                <th>Cores</th>
                <th id="metricColumns">Metric Data</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button type="button" id="saveConfigurations">Save Configurations</button>

    <script>
        $(document).ready(function() {
            $('#generation').change(function() {
                $.post('/get_servers', {generation: $(this).val()}, function(data) {
                    $('#server').empty();
                    $.each(data, function(i, server) {
                        $('#server').append('<option value="' + server[0] + '">' + server[0] + '</option>');
                    });
                });
            });

            $('#server').change(function() {
                $.post('/get_cores', {server: $(this).val()}, function(data) {
                    $('#cores').empty();
                    $.each(data, function(i, core) {
                        $('#cores').append('<option value="' + core[0] + '">' + core[0] + '</option>');
                    });
                });
            });

            $('#metric').change(function() {
                $('#metricData').empty();
            });

            $('#addServer').click(function() {
                const generation = $('#generation').val();
                const server = $('#server').val();
                const cores = $('#cores').val();
                const metric = $('#metric').val();

                $.post('/get_metric_data', {metric: metric, cores: cores, server: server}, function(data) {
                    let metricHtml = '';
                    if (metric === 'rperf') {
                        metricHtml = '<td>' + data[0].st + '</td><td>' + data[0].smt2 + '</td><td>' + data[0].smt4 + '</td><td>' + data[0].smt8 + '</td>';
                    } else if (metric === 'saps') {
                        metricHtml = '<td>' + data[0].sd_bench_saps + '</td><td>' + data[0].hana_prod_saps + '</td>';
                    } else if (metric === 'spec') {
                        metricHtml = '<td>' + data[0].specrate2017_int_peak + '</td><td>' + data[0].specrate2017_int_basek + '</td>';
                    } else if (metric === 'cpw') {
                        metricHtml = '<td>' + data[0].cpw + '</td>';
                    }

                    $('#serverTable tbody').append('<tr><td>' + generation + '</td><td>' + server + '</td><td>' + cores + '</td>' + metricHtml + '</tr>');
                });
            });

            $('#saveConfigurations').click(function() {
                const configurations = [];
                $('#serverTable tbody tr').each(function() {
                    const row = $(this);
                    const config = {
                        generation: row.find('td').eq(0).text(),
                        server: row.find('td').eq(1).text(),
                        cores: row.find('td').eq(2).text()
                    };

                    if ($('#metric').val() === 'rperf') {
                        config.st = row.find('td').eq(3).text();
                        config.smt2 = row.find('td').eq(4).text();
                        config.smt4 = row.find('td').eq(5).text();
                        config.smt8 = row.find('td').eq(6).text();
                    } else if ($('#metric').val() === 'saps') {
                        config.sd_bench_saps = row.find('td').eq(3).text();
                        config.hana_prod_saps = row.find('td').eq(4).text();
                    } else if ($('#metric').val() === 'spec') {
                        config.specrate2017_int_peak = row.find('td').eq(3).text();
                        config.specrate2017_int_basek = row.find('td').eq(4).text();
                    } else if ($('#metric').val() === 'cpw') {
                        config.cpw = row.find('td').eq(3).text();
                    }

                    configurations.push(config);
                });

                $.ajax({
                    url: '/save_configurations',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({configurations: configurations}),
                    success: function(response) {
                        alert('Configurations saved successfully!');
                    }
                });
            });
        });
    </script>
</body>
</html>
